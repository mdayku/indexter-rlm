# Indexter-RLM Cursor Rules

## The RLM Loop (MUST FOLLOW)

Before reasoning about code, you MUST follow this loop:

```
1. SEARCH  -> Find relevant code via semantic search
2. OPEN    -> Read the actual source files
3. RECORD  -> Save observations as notes
4. REFINE  -> Search again based on findings
5. REPEAT  -> Until you have sufficient context
```

### Search-Before-Reasoning Enforcement

For ANY task involving:
- Understanding existing code
- Modifying non-trivial logic
- Debugging behavior
- Refactoring
- Explaining system design

You MUST:
1. Query Indexter via `search_repository()` with a semantic search describing the intent
2. Use `get_symbols()` to understand file structure before reading
3. Use `read_file()` to inspect actual implementation
4. Cite the retrieved code (file paths and line numbers) in your reasoning

**DO NOT** rely on assumptions, memory, or prior messages as a substitute for search results.
If search returns no results, state that explicitly and try alternative queries.

### Note-Taking Requirements (Multi-Step Tasks)

For tasks requiring 3+ steps or involving multiple files:

1. **Before starting**: Create a note with your exploration plan
   ```
   save_note("repo", "plan", "1. Find auth logic 2. Trace token flow 3. Check expiry")
   ```

2. **During exploration**: Record key findings as you discover them
   ```
   save_note("repo", "auth_location", "JWT validation in src/auth/middleware.py:45-80")
   ```

3. **Before concluding**: Review accumulated notes
   ```
   list_notes("repo")
   ```

4. **After completion**: Clean up temporary notes
   ```
   remove_all_notes("repo")
   ```

---

## Quick Reference

```bash
# Development
pip install -e ".[full]"        # Install with all extras
pytest                          # Run tests
ruff check . --fix              # Lint and fix
ruff format .                   # Format code

# CLI
indexter-rlm init <path>        # Register a repo
indexter-rlm index <name>       # Index a repo
indexter-rlm search "<query>" <name>  # Search
indexter-rlm status             # Show all repos

# MCP Server
rlm-mcp                         # Start MCP server (stdio)
```

## Code Style

- **Ruff**: 100 char lines, double quotes, trailing commas in multi-line
- **Type hints**: All function signatures (args + return types)
- **Docstrings**: Google-style for public functions/classes
- **Python**: >=3.10

```python
async def search_repo(
    name: str,
    query: str,
    limit: int | None = None,
) -> dict:
    """Search a repository for semantically similar code.

    Args:
        name: Repository name.
        query: Natural language search query.
        limit: Maximum results to return.

    Returns:
        Dict with results list and count.
    """
```

## Agent Safety Rules (MUST FOLLOW)

1. **No broad refactors** without explicit user request
2. **No new dependencies** without updating `pyproject.toml`
3. **No changes to public models** (`Repo`, `RepoSettings`, `IndexResult`, `Note`) without updating tests
4. **Always add/update tests** when touching models, store, or MCP tools
5. **Avoid new files** unless necessary; prefer extending existing modules

**Critical modules** (require careful changes):
- `src/indexter_rlm/models.py` - `Repo`, `IndexResult`, `Note`
- `src/indexter_rlm/config.py` - `Settings`, `RepoSettings`
- `src/indexter_rlm/mcp/server.py` - MCP tool definitions
- `src/indexter_rlm/mcp/notes.py` - Note storage
- `src/indexter_rlm/store.py` - Vector store operations

## Where to Add Things

| What | Where |
|------|-------|
| CLI commands | `src/indexter_rlm/cli/cli.py` |
| CLI config subcommands | `src/indexter_rlm/cli/config.py` |
| MCP tools | `src/indexter_rlm/mcp/server.py` (define) + `mcp/tools.py` (implement) |
| MCP prompts | `src/indexter_rlm/mcp/prompts.py` |
| Language parsers | `src/indexter_rlm/parsers/<language>.py` |
| Tests | `src/indexter_rlm/<module>/tests/` |

## MCP Tool Changes Checklist

When adding new MCP tools:
- [ ] Add tool function in `mcp/tools.py`
- [ ] Register with `@mcp.tool()` in `mcp/server.py`
- [ ] Add tests in `mcp/tests/test_tools.py`
- [ ] Update `mcp/prompts.py` workflow guide
- [ ] Update README.md MCP section

## Parser Changes Checklist

When adding/modifying language parsers:
- [ ] Create/update parser in `parsers/<language>.py`
- [ ] Register in `parsers/__init__.py`
- [ ] Add tests in `parsers/tests/test_<language>_parser.py`
- [ ] Update README.md supported languages

## Documentation

- Keep `BACKLOG.md` focused on active work (current sprint)
- `PRD.md` contains vision, architecture decisions, and changelog
- `ARCHITECTURE.md` documents system design and data flow
